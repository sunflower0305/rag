# 用户专属API密钥功能使用指南

本文档说明用户专属API密钥存储和管理功能的使用方法。

## 功能概述

### 🔑 核心特性

- ✅ **自动保存**：GitHub登录用户输入的API密钥会自动加密保存
- ✅ **安全存储**：使用军事级加密算法保护API密钥
- ✅ **自动加载**：下次登录自动恢复API密钥，无需重新输入
- ✅ **用户隔离**：每个用户的API密钥完全独立，互不干扰
- ✅ **历史隔离**：用户只能看到自己的聊天历史和会话记录

### 🛡️ 安全特性

- **AES-256加密**：使用Fernet对称加密算法
- **密钥派生**：基于PBKDF2-HMAC-SHA256密钥派生函数
- **本地存储**：所有数据存储在本地SQLite数据库
- **自动密钥管理**：系统自动生成和管理加密密钥

## 使用流程

### 1. 用户登录

1. **启动应用**：
   ```bash
   python start_with_oauth.py
   ```

2. **GitHub登录**：
   - 点击界面右上角的GitHub登录链接
   - 完成GitHub OAuth授权
   - 返回应用后点击"刷新登录状态"

### 2. API密钥管理

#### 首次设置API密钥

1. **输入API密钥**：
   - 在"DashScope API密钥"输入框中填入您的API密钥
   - 选择向量存储类型（ChromaDB或FAISS）
   - 点击"初始化API"

2. **自动保存**：
   - 系统会自动加密保存您的API密钥
   - 显示"✅ API初始化成功"消息

#### 后续使用

1. **自动加载**：
   - 登录后系统会自动尝试使用保存的API密钥
   - 如果成功，会显示"✅ 已使用您保存的API密钥自动初始化"

2. **手动操作**：
   - **自动填充**：点击"🔄 使用保存的密钥"按钮
   - **查看状态**：在用户设置区域查看当前保存的密钥（脱敏显示）
   - **清除密钥**：点击"🗑️ 清除"按钮删除保存的密钥

### 3. 数据隔离

#### 会话隔离

- **个人会话**：只能看到自己创建的会话
- **历史记录**：搜索和浏览功能仅限个人数据
- **统计信息**：会话统计只计算个人数据

#### 文档隔离

- **上传文档**：使用个人API密钥处理
- **文档列表**：只显示当前会话的文档
- **向量存储**：使用个人API密钥创建的向量数据库

## 界面说明

### 主要区域

1. **用户状态显示**：
   - 显示当前登录用户信息
   - 显示API密钥保存状态
   - 提供登录/登出功能

2. **API设置区域**：
   - API密钥输入框
   - 自动填充按钮
   - 向量存储类型选择

3. **用户设置区域**（登录后显示）：
   - 当前保存的API密钥（脱敏显示）
   - 清除API密钥按钮
   - 使用提示

4. **历史记录区域**：
   - 个人会话列表
   - 会话详情和操作
   - 搜索功能

### 状态指示

- **🔑 已保存密钥**：用户已保存API密钥
- **⚠️ 未保存密钥**：用户未保存API密钥
- **✅ 自动初始化成功**：使用保存的密钥成功初始化
- **❌ 初始化失败**：需要手动输入或更新密钥

## 数据管理

### 数据存储

- **位置**：`sqlite/chat_history.db`
- **加密密钥**：`sqlite/encryption.key`
- **盐值**：`sqlite/salt.key`

### 数据备份

```bash
# 备份数据库文件
cp sqlite/chat_history.db sqlite/chat_history_backup.db

# 备份加密密钥（重要）
cp sqlite/encryption.key sqlite/encryption_backup.key
cp sqlite/salt.key sqlite/salt_backup.key
```

### 数据清理

```bash
# 清除所有用户数据
rm -rf sqlite/

# 清除特定用户数据（需要数据库操作）
# 建议使用应用内的删除功能
```

## 安全注意事项

### 密钥安全

1. **加密密钥保护**：
   - 确保`sqlite/encryption.key`文件安全
   - 不要将密钥文件提交到代码仓库
   - 定期备份密钥文件

2. **API密钥管理**：
   - 定期轮换DashScope API密钥
   - 监控API使用情况
   - 及时清除不需要的密钥

### 环境安全

1. **生产环境**：
   - 设置`DB_ENCRYPTION_PASSWORD`环境变量
   - 使用强密码作为加密基础
   - 启用HTTPS保护传输

2. **访问控制**：
   - 限制数据库文件访问权限
   - 监控异常访问行为
   - 定期审查用户权限

## 故障排除

### 常见问题

1. **API密钥丢失**：
   - 检查用户设置区域是否显示密钥
   - 尝试重新输入并保存密钥
   - 检查加密密钥文件是否存在

2. **自动初始化失败**：
   - 验证保存的API密钥是否有效
   - 检查网络连接和API服务状态
   - 手动重新输入API密钥

3. **会话数据缺失**：
   - 确认使用正确的GitHub账户登录
   - 检查数据库文件完整性
   - 验证用户ID匹配

### 调试方法

1. **检查数据库**：
   ```python
   from chat_history_db import ChatHistoryDB
   db = ChatHistoryDB()
   
   # 检查用户信息
   user = db.get_user(user_id)
   print(f"用户信息: {user}")
   
   # 检查API密钥
   api_key = db.get_user_api_key(user_id)
   print(f"API密钥存在: {bool(api_key)}")
   ```

2. **查看日志**：
   - 检查应用启动日志
   - 关注数据库初始化消息
   - 查看API密钥操作日志

## 最佳实践

### 使用建议

1. **定期备份**：
   - 备份数据库和加密密钥
   - 记录重要的会话ID
   - 导出重要的对话内容

2. **安全操作**：
   - 使用强密码保护GitHub账户
   - 启用两因素认证
   - 定期检查登录活动

3. **数据管理**：
   - 定期清理无用的会话
   - 监控存储空间使用
   - 及时更新API密钥

### 开发建议

1. **环境变量**：
   ```bash
   # 设置强加密密码
   export DB_ENCRYPTION_PASSWORD="your_super_secure_password_here"
   
   # GitHub OAuth配置
   export GITHUB_CLIENT_ID="your_client_id"
   export GITHUB_CLIENT_SECRET="your_client_secret"
   ```

2. **权限设置**：
   ```bash
   # 限制数据库文件权限
   chmod 600 sqlite/chat_history.db
   chmod 600 sqlite/encryption.key
   chmod 600 sqlite/salt.key
   ```

这个功能为每个用户提供了完全独立和安全的API密钥管理体验，确保了数据的隐私性和安全性。